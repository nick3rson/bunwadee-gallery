<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bunwadee</title>
  <link rel="shortcut icon" href="icon/icon.png" type="image/x-icon">
  <link rel="stylesheet" href="style.css">

  <!-- icon -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Winky+Sans:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
</head>
<body>

  <!-- Upload Modal -->
  <div id="uploadModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center;">
    <div class="modal-content" style="background:white; padding:20px; border-radius:10px; position:relative; width:300px;">
      <span class="close" onclick="closeModal()" style="position:absolute; top:10px; right:10px; cursor:pointer;">&times;</span>
      <h3>อัปโหลดรูปภาพ</h3>
      <form id="uploadForm" enctype="multipart/form-data">
        <input type="text" name="filename" placeholder="ตั้งชื่อไฟล์" required class="name-input"/>
        <input type="file" name="image" accept=".png,.jpg,.jpeg,.gif,.heic" required>
        <input type="password" name="password" placeholder="รหัสผ่าน" required class="name-input"/>
        <button type="submit">อัพโหลด</button>
      </form>
    </div>
  </div>

  <div class="container">
    <!-- Navbar -->
    <div class="navbar">
      <ul>
        <li class="tooltip"><a href="#"><i class="bi bi-house-heart-fill"></i><span class="tooltip-text">หน้าหลัก</span></a></li>
        <li class="tooltip">
          <a href="javascript:void(0)" onclick="openModal()">
            <i class="bi bi-plus-square"></i>
            <span class="tooltip-text">สร้าง</span>
          </a>
        </li>
        <li class="tooltip"><a href="#"><i class="bi bi-bell"></i><span class="tooltip-text">อัปเดต</span></a></li>
        <li class="tooltip"><a href="message.html"><i class="bi bi-chat-dots"></i><span class="tooltip-text">ข้อความ</span></a></li>
      </ul>
      <div class="settings tooltip">
        <a href="#" class="setbut"><i class="bi bi-gear"></i><span class="tooltip-text">การตั้งค่า</span></a>
      </div>
    </div>

    <div class="content">
      <!-- Header -->
      <div class="header">
        <div class="search">
          <div class="search-container">
            <span class="search-icon"><i class="bi bi-search-heart"></i></span>
            <input type="text" class="search-box" placeholder="Search">
          </div>
        </div>
        <div class="profile-box">
          <div class="profile"><p>N</p></div>
        </div>
      </div>

      <!-- Gallery -->
      <div class="gallery-box">
        <div class="gallery">
          <!-- Dynamic images will be inserted here -->
        </div>
      </div>
    </div>

    <div class="footer"></div>
  </div>




</body>
<script>
// โหลดรูปทั้งหมดจาก Cloudinary
async function loadImages() {
  const res = await fetch('/images');
  const files = await res.json();
  const gallery = document.querySelector('.gallery');
  gallery.innerHTML = '';

  files.forEach(file => {
    const picDiv = document.createElement('div');
    picDiv.className = 'pic';
    picDiv.setAttribute('data-name', file.filename.toLowerCase());

    picDiv.innerHTML = `
      <img src="${file.url}" alt="${file.filename}">
      <div class="overlay">
        <button class="btn btn-danger" onclick="deleteImage('${file.filename}')">ลบ</button>
        <a href="${file.url}" download class="btn">ดาวน์โหลด</a>
      </div>
    `;
    gallery.appendChild(picDiv);
  });
}

// เรียกตอนโหลดหน้า
window.addEventListener('DOMContentLoaded', loadImages);

// เปิด modal
function openModal() {
  document.getElementById('uploadModal').style.display = 'block';
}

// ปิด modal
function closeModal() {
  document.getElementById('uploadModal').style.display = 'none';
}

// ปิด modal เมื่อคลิกนอกกล่อง
window.addEventListener('click', (event) => {
  const modal = document.getElementById('uploadModal');
  if (event.target === modal) modal.style.display = 'none';
});

// Search
const searchInput = document.querySelector('.search-box');
searchInput.addEventListener('input', async () => {
  const keyword = searchInput.value.toLowerCase();
  const res = await fetch('/images');
  const files = await res.json();
  const gallery = document.querySelector('.gallery');
  gallery.innerHTML = '';

  files
    .filter(file => file.filename.toLowerCase().includes(keyword))
    .forEach(file => {
      const picDiv = document.createElement('div');
      picDiv.className = 'pic';
      picDiv.setAttribute('data-name', file.filename.toLowerCase());

      picDiv.innerHTML = `
        <img src="${file.url}" alt="${file.filename}">
        <div class="overlay">
          <button class="btn btn-danger" onclick="deleteImage('${file.filename}')">ลบ</button>
          <a href="${file.url}" download class="btn">ดาวน์โหลด</a>
        </div>
      `;
      gallery.appendChild(picDiv);
    });
});

async function deleteImage(url) {
  const password = prompt('ใส่รหัสผ่านเพื่อลบรูป:');
  if (!password) return;

  try {
    // ดึงชื่อไฟล์จาก URL
    const parts = url.split('/');
    const filename = parts[parts.length - 1]; // cbgexpfpx5dmkjufgrpz.jpg
    const public_id = filename.replace(/\.[^/.]+$/, ''); // ตัด .jpg → cbgexpfpx5dmkjufgrpz

    // ถ้าอยู่ใน folder bunwadee
    const folderIndex = parts.findIndex(p => p === 'bunwadee');
    if (folderIndex >= 0) {
      const pathParts = parts.slice(folderIndex); // ["bunwadee","cbgexpfpx5dmkjufgrpz.jpg"]
      public_id = pathParts.join('/').replace(/\.[^/.]+$/, ''); // bunwadee/cbgexpfpx5dmkjufgrpz
    }

    const res = await fetch('/delete', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ public_id, password })
    });

    const data = await res.json();
    console.log(data);

    if (data.success) {
      alert('ลบสำเร็จ!');
      loadImages(); // โหลด gallery ใหม่
    } else {
      alert(data.error || 'ลบไม่สำเร็จ');
    }
  } catch (err) {
    console.error(err);
    alert('เกิดข้อผิดพลาดในการลบ');
  }
}




// Upload form
const uploadForm = document.getElementById('uploadForm');

// ฟังก์ชันเดียว handle ทั้งปุ่ม submit และ Enter
async function handleUpload(e) {
  e.preventDefault();

  const formData = new FormData(uploadForm);

  try {
    const res = await fetch('/upload', { method: 'POST', body: formData });
    const data = await res.json();

    if (res.ok && data.success) {
      loadImages();
      uploadForm.reset();   // เคลียร์ input
      closeModal();         // ปิด modal หลัง upload สำเร็จ
    } else {
      alert(data.error || 'อัพโหลดไม่สำเร็จ');
    }
  } catch {
    alert('รหัสผ่านไม่ถูกต้องหรือเกิดข้อผิดพลาดในการอัพโหลด');
  }
}

// bind form submit
uploadForm.addEventListener('submit', handleUpload);

// bind Enter key เฉพาะ input (ปลอดภัย ไม่ซ้ำ)
uploadForm.querySelectorAll('input').forEach(input => {
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault(); // ป้องกัน browser submit ปกติ
      handleUpload(new Event('submit', { bubbles: true, cancelable: true }));
    }
  });
});
</script>

</html>
